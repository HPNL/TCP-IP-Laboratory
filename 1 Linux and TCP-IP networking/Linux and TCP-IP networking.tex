\documentclass{../UTNetLab}

\title{Linux and TCP/IP Networking}
\authorshort{A. Khonsari, A. HajiAliKhamseh'i, M. Borhani, A. Khordadi, S. Kashipazha}
\author{%
    Dr. Ahmad Khonsari\\
    \FR{دکتر احمد خونساری}\\
    \mail{a\_khonsari@ut.ac.ir}
    \end{tabular}\vskip 1em
    \begin{tabular}[t]{c}
    Amir Haji Ali Khamseh'i\\
    \FR{امیر حاجی‌علی‌خمسه‌ء}\\
    \mail{khamse@ut.ac.ir}
    \and
    {Muhammad Borhani}\\
    \FR{محمد برهانی}\\
    \mail{m.borhani@ut.ac.ir}
    \and
    {AmirAhmad Khordadi}\\
    \FR{امیراحمد خردادی}\\
    \mail{a.a.khordadi@ut.ac.ir}
    \and
    {Sina Kashipazha}\\
    \FR{سینا کاشی‌پزها}\\
    \mail{sina\_kashipazha@ut.ac.ir}
    \and
    {Hadi Safari}\\
    \FR{هادی صفری}\\
    \mail{hadi.safari@ut.ac.ir}
    \and
    % {alii}\\
    % \FR{دیگران}\\
    % \mail{info@example.com}
}

\begin{document}
    \selectlanguage{english}
    \maketitle

\section*{Systems configuration}
    Launch GNS3 and make a network as below. You can use "\textbf{ifconfig \texttt{eth0} 192.168.0.1 netmask 255.255.255.0}" to set ip.
    \begin{center}
        %	\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
        \begin{minipage}{0.48\textwidth}
            \begin{flushleft}
                \begin{table}[H]
                    \caption{The IP addresses of the hosts}
                    \vspace{5pt}
                    \centering
                    \begin{tabular}{ l l l }
                        \hline \hline
                        Host & IP Address & Subnet Mask \\
                        \hline 
                        h0 (shakti) & 128.238.66.100 & 255.255.255.0 \\
                        h1 (vayu) & 128.238.66.101 & 255.255.255.0 \\
                        h2 (agni) & 128.238.66.102 & 255.255.255.0 \\
                        h3 (apah) & 128.238.66.103 & 255.255.255.0 \\
                        h4 (yachi) & 128.238.66.104 & 255.255.255.0 \\
                        h5 (fenchi) & 128.238.66.105 & 255.255.255.0 \\
                        h6 (kenchi) & 128.238.66.106 & 255.255.255.0 \\
                        h7 (guchi) & 128.238.66.107 & 255.255.255.0 \\
                        \hline \hline
                        \end{tabular}
                \end{table}
            \end{flushleft}
        \end{minipage}
        \begin{minipage}{0.48\textwidth}
            \begin{flushright}
                \begin{figure}[H]
                    \centering
                    \begin{tikzpicture}[font=\sf]
                        \node[draw] (s) at (0,0){Core Switch};
                        \node[draw,circle] (h0) at (0,2){h0};
                        \node[draw,circle] (h1) at ({sqrt(2)},{sqrt(2)}){h1};
                        \node[draw,circle] (h2) at (2,0){h2};
                        \node[draw,circle] (h3) at (-{sqrt(2)},{sqrt(2)}){h3};
                        \node[draw,circle] (h4) at (-2,0){h4};
                        \node[draw,circle] (h5) at (-{sqrt(2)},-{sqrt(2)}){h5};
                        \node[draw,circle] (h6) at (0,-2){h6};
                        \node[draw,circle] (h7) at ({sqrt(2)},-{sqrt(2)}){h7};
                    
                        \draw[thick] (h0) -- (s);
                        \draw[thick] (h1) -- (s);
                        \draw[thick] (h2) -- (s);
                        \draw[thick] (h3) -- (s);
                        \draw[thick] (h4) -- (s);
                        \draw[thick] (h5) -- (s);
                        \draw[thick] (h6) -- (s);
                        \draw[thick] (h7) -- (s);
                    \end{tikzpicture}
                    \caption{A single segment network}        
                \end{figure}
            \end{flushright}
        \end{minipage}
    \end{center}

\section{Telnet service}
    Run \textbf{ps -e} to list the processes running in \texttt{h1}.
    After starting a new process by running \textbf{telnet} in another command window, execute \textbf{ps -e} again in a third window to see if there is any change in its output. \\
    Find the process id of the \textbf{telnet} process you started, by: \\
    \centerline{\textbf{ps -e | grep telnet}} \\
    Then use \textbf{kill} \textit{process-id-of-telnet} to terminate the \textbf{telnet} process.
    \subsection*{Report}
    What is Internet service daemon (inetd)? \\
    Is \textbf{inetd} started in your system?
    Why? \\
    Is \textbf{xinetd} started in your system? What is its PID? \\

\section{Default network services}
    Display the file \texttt{/etc/services} on \texttt{h1} screen, using: \\
    \centerline{\textbf{more} \texttt{/etc/services}} \\
    Then in another console, use the redirect operator to redirect the \textbf{more} output to
    a file using \textbf{more} \texttt{/etc/services > ser-more}. Compare the file \texttt{ser-more} with the original \textbf{more} output in the other command window. \\
    Copy \texttt{/etc/services} file to a local file named \texttt{ser-cp} in your working directory,
    using \textbf{cp} \texttt{/etc/services ser-cp}. Compare files \texttt{ser-more} and \texttt{ser-cp}, using \textbf{cmp} \texttt{ser-more ser-cp}. Are these two files identical?\\
    Concatenate these two files using \textbf{cat} \texttt{ser-more ser-cp > ser-cat}. \\
    Display the file sizes using \textbf{ls -l ser*}. Save the output. What are the sizes of files \texttt{ser-more}, \texttt{ser-cp}, and \texttt{ser-cat}?

\section{Network command manual}
    Read the \textbf{man} pages for the following programs:
    \begin{multicols}{3}
        \begin{enumerate}
            \item arp
            \item arping
            \item ifconfig
            \item tcpdump
            \item ping
            \item netstat
            \item route
            \item wireshark
            \item iptables
        \end{enumerate}
    \end{multicols}
    Study the different options associated with each command.
    Throughout this lab you will use these commands rather extensively.
    \subsection*{Report}
    Explain the above commands briefly.
    Two or three sentences per command would be adequate.

\section{Packet capturing}
    In this exercise, we will use \textbf{tcpdump} to capture a packet containing the link, IP, and TCP headers and use \textbf{wireshark} to analyze this packet. \\
    First, run \textbf{tcpdump -enx -w} \texttt{dump.out} in \texttt{h1}.
    You will not see any \textbf{tcpdump} output, since the \textbf{-w} option is used to write the output to the \texttt{dump.out} file. \\
    Then, you may want to run \textbf{telnet} \texttt{10.0.0.2} to generate some TCP traffic.\footnote{Remember to run \textbf{\texttt{/etc/init.d/xinetd} restart} in \texttt{h2} to start telnet server on it.}
    After you login to \texttt{h2}, terminate the \textbf{telnet} session and terminate the \textbf{tcpdump} program.
    Next, you will use \textbf{wireshark} to open the packet trace captured by \textbf{tcpdump} and analyze the captured packets.
    To do this, run \textbf{wireshark} \texttt{dump.out \&}.
    The \textbf{wireshark} Graphical User Interface (GUI) will pop up and the packets captured by \textbf{tcpdump} will be displayed.
    Select any one of the packets that contain the link, IP, and TCP headers.
    \subsection*{Report}
    What is the value of the \texttt{protocol} field in the IP header of the packet you saved?
    What is the use of the \texttt{protocol} field? \\
    What is the value of the \texttt{frame type} field in an Ethernet frame carrying an IP datagram?

\section{ARPing}
    This time we will run wireshark to capture an ARP request and an ARP reply in real-time. Simply run \textbf{wireshark \&} in \texttt{h1} and select the interface and start capturing.
    If there is no arp requests and replies in the network, generate some using \textbf{arping} \textit{10.0.0.2}. \\
    Now you should see several ARP replies in the arping output.
    \subsection*{Report}
    What is the value of the \texttt{frame type} field in an Ethernet frame carrying an ARP request and in an Ethernet frame carrying an ARP reply, respectively? \\
    What is the use of the \texttt{frame type} field? \\

\section{Packet filtering}
    Using the \textbf{tcpdump} utility, capture any packet on the LAN and see the output format
    for different command-line options. Study the various expressions for selecting
    which packets to be dumped.\\
    For this experiment, use the \textbf{man} page for \textbf{tcpdump} to find out the options and
    expressions that can be used.\\
    If there is no traffic on the network, you may generate traffic with some applications
    (e.g. \textbf{telnet}, \textbf{ping}, etc.).\\
    \subsection*{Report}
    Explain briefly the purposes of the following \textbf{tcpdump} expressions. If using wireshark, use next list
    \begin{itemize}
        \item \textbf{tcpdump udp port 520}
        \item \textbf{tcpdump -x -s 120 ip proto 89}
        \item \textbf{tcpdump -x -s 70 host \texttt{ip\_addr1} and (\texttt{ip\_addr2} or \texttt{ip\_addr3})}
        \item \textbf{tcpdump -x -s 70 host \texttt{ip\_addr1} and not \texttt{ip\_addr2}}
    \end{itemize}
    If you ar using \textbf{wireshark} explain the following filter.
    \begin{itemize}
        \item \textbf{udp.port == 520}
        \item \textbf{ip.proto == 89}
        \item \textbf{ip.addr == \texttt{ip\_addr1} and (ip.addr == \texttt{ip\_addr2} or ip.addr == \texttt{ip\_addr3})}
        \item \textbf{ip.addr == \texttt{ip\_addr1} and not ip.addr \texttt{ip\_addr2}}
    \end{itemize}

\section{Connection port}
    In \texttt{h1} run \textbf{wireshark \&} and select an interface to capture packets between hosts. \\
    Execute a TCP utility, \textbf{telnet} for example, in another command window: \\
    \textbf{telnet} \textit{10.0.0.2}
    \subsection*{Report}
    What are the port numbers used by the \texttt{h1} (local machine) and \texttt{h2} (remote machine)? \\
    Which machine’s port number matches the port number listed for \textbf{telnet} in the \texttt{/etc/services} file? \\

\section{Random port}
    In \texttt{h1} run \textbf{wireshark \&} and select an interface to capture packets between hosts. \\
    Then, \textbf{telnet} to the \texttt{h2} from a second command window by typing \textbf{telnet} \textit{10.0.0.2}.
    Again issue the same \textbf{telnet} \textit{10.0.0.2} command from a third command window.
    Now you are opening two \textbf{telnet} sessions to \texttt{h2} simultaneously, from two different command windows. \\
    Check the port numbers being used on both sides of the two connections from the output in the \textbf{wireshark} window. \\
    \subsection*{Report}
    When you have two \textbf{telnet} sessions with your machine, what port number is used on the \texttt{h2} (remote machine)? \\
    Are both sessions connected to the same port number on the \texttt{h2} (remote machine)? \\
    What port numbers are used in \texttt{h1} (local machine) for the first and second \textbf{telnet}, respectively? \\
    Explain briefly what a \texttt{socket} is. \\
\end{document}