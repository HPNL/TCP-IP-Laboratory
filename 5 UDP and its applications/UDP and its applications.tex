\documentclass{../UTNetLab}

\title{UDP and Its Applications}
\newcommand\reference{
   S. Panwar, S. Mao, J.-dong Ryoo, and Y. Li, “UDP and its applications,” in TCP/IP Essentials: A Lab-Based Approach, Cambridge: Cambridge University Press, 2004, pp. 100–110.
}

\begin{document}
\part{Using the \texttt{socket} Program}
\label{sec:schema}
    In this lab, you will not need to a router, only two workstations and one hub to connect two host together as show in \hyperref[fig:5.0]{Figure~5.0} and \hyperref[tab:5.0]{Table~5.0}.
    \begin{table}[H]
        \caption{Host IP addresses for \hyperref[fig:5.0]{Figure~5.0}}
        \label{tab:5.0}
        \centering
        \begin{tabular}{ *2c|*2c }
            \hline \hline
            \multicolumn{2}{c|}{Host\textsubscript{A}} & \multicolumn{2}{c}{Host\textsubscript{B}} \\
            Name & IP Address & Name & IP Address \\
            \hline 
            h0 & 128.238.61.100/24 & h1 & 128.238.61.101/24\\
            \hline \hline
            \end{tabular}
    \end{table}

    \begin{figure}[H]
        \centering
        \begin{tikzpicture}
            \node[draw] (h1) at (-2,0){Host\textsubscript{A}};
            \node[draw,rounded corners] (hub) at (0,0){Hub};
            % \node[draw,rounded corners] (router) at (0,0){Router};
            % \node[draw,rounded corners] (hub1) at (2,0){Switch 1};
            \node[draw] (h0) at (2,0){Host\textsubscript{B}};
        
            \draw (h0) -- (hub) -- (h1);
        \end{tikzpicture}
        \caption{Simple router experiment (Figure~5.0)}        
        \label{fig:5.0}
    \end{figure}

\section{Socket Operation}
    Use the following commands in \textit{h0} and \textit{h0} to observe the basic operation of \lstinline{socket}\footnote{Basic command is \lstinline{sock} use alternative \lstinline{socket} (rename of \lstinline{sock})} and \lstinline{echo} service.
    \begin{lstlisting}[emph={host, server-host}]
socket [-u] host echo@\footnote{Type any text in socket and press enter.}@
socket -s 5555
socket -i -n3 -w2048 server-host 5555
    \end{lstlisting}

    \begin{report}
    \item Explain the operation of each command.
    \end{report}

\section{\texttt{socket -h}}
    Study various options associated with the \lstinline{socket} program.
    A brief list of options can be displayed by typing \lstinline{socket}. More detailed discussion on socket can be found in
    Appendix~C of [5] in the reference book.

\section{Segment Size}
    While running \lstinline{tcpdump -nv} on \textit{your-host} or \textit{remote-host}, execute the following command with different values of size (i.e.\  the size of the datagram).

    \begin{lstlisting}[emph={size, remote-host}]
socket -u -i -n1 -w size remote-host echo
    \end{lstlisting}
    
    The \lstinline{-u} option is used to send UDP datagrams rather than TCP segments.

    Increase \textit{size} (i.e.\  the size of the datagram) until fragmentation occurs.

    Use \lstinline{netstat -in} to find out the MTU of the Ethernet interface.

    \begin{report}
    \item What is the maximum value of \textit{size} for which the UDP datagram can be sent without IP fragmentation?
    Justify your answer with the \lstinline{netstat} output.
    \end{report}

\section{Datagram Fragmentation}
    Capture the data packets generated by the following command \lstinline[emph={your-host, remote-host}]{tcpdump src host your-host} on \textit{h1}.

    \begin{lstlisting}[emph={host}]
socket -u -i -n1 -w10000 host echo
    \end{lstlisting}
    Save the \lstinline{tcpdump} output for the lab report.
    
    \begin{report}
    \item Explain the \lstinline{tcpdump} output in terms of the IP header fields that are used in fragmentation.

    \item When IP fragmentation occurs, only the first fragment has the UDP header.
    How do you verify this fact from the \lstinline{tcpdump} output?
    \end{report}


\section{Maximum Datagram Size}
\label{sec:MaxDatagramSize}
    While running tcpdump src host your host, execute the following command with different values of size,
    \begin{lstlisting}[emph={host}]
socket -u -i -n1 -w10000 host echo@
% socket -u -i -n1 -w65507 host echo@
    \end{lstlisting}
    in order to find out the maximum size of a UDP datagram that the system can send or receive, even when fragmentation is allowed.

    \begin{report}
    \item What is the maximum size of user data in a UDP datagram that the system can send or receive, even when fragmentation is allowed?
    \end{report}


\part{Path MTU Discovery Exercise}\label{sec:PMTUD}

\section{Discover path MTU}
    Connect the routers and the workstations as shown in \hyperref[fig:5.5]{Figure~5.5} Change the IP
    addresses of your workstation accordingly. Note that the router IP addresses are
    the same as their default.

    % Open console of  each router, enable {RIP} routing (See Section~4.6 of reference book).

    Change the \texttt{MTU} of the \textit{ethernet1} interfaces of \textit{Router4} to 500
    bytes.
    \begin{lstlisting}[language={cisco}]
R1(config-if)# ip mtu 500
    \end{lstlisting}
    Test connectivity by \lstinline{ping}ing hosts in the other subnets. After you can reach the
    hosts in the other subnets, run \lstinline{tcpdump -nx} on your workstation.

    Start a UDP socket server on \textit{remote-host}, using \lstinline{socket -u -s 5555}.
    Then run the socket client from \textit{your-host}:
    \begin{lstlisting}[emph={your-host, remote-host}]
socket -i -u -n10 -w1200 -p5 remote-host 5555
    \end{lstlisting}

    \begin{table}[H]
        \caption{Router and Host IP addresses for \hyperref[fig:5.5]{Figure~5.5} (Table~5.5)}
        \centering
        \begin{tabular}{ *2c|*2c|*2c }
            \hline \hline
            \multicolumn{2}{c|}{Router} & \multicolumn{2}{c|}{Host\textsubscript{A}} & \multicolumn{2}{c}{Host\textsubscript{B}} \\
            eth0 & eth1 & Name & IP Address & Name & IP Address \\
            \hline 
            128.238.61.1/24 & 128.238.62.1/24 & h0 & 128.238.61.101/24 & h1 & 128.238.62.101/24 \\
            \hline \hline
            \end{tabular}
    \end{table}

    \begin{figure}[H]
        \centering
        \begin{tikzpicture}
            \node[draw] (h1) at (-4,0){Host\textsubscript{A}};
            \node[draw,rounded corners] (hub2) at (-2,0){Switch 2};
            \node[draw,rounded corners] (router) at (0,0){Router};
            \node[draw,rounded corners] (hub1) at (2,0){Switch 1};
            \node[draw] (h0) at (4,0){Host\textsubscript{B}};
        
            \draw (h0) -- (hub1);
            \draw (h1) -- (hub2);
            \draw[thick] (hub1) -- (router);
            \draw[thick] (hub2) -- (router);
        \end{tikzpicture}
        \caption{The network setup for \nameref{sec:PMTUD} (Figure~5.5/Figure~4.10)}
        \label{fig:5.5}
    \end{figure}

    Observe the DF bit of the first datagram and that of the following datagrams. Save the \lstinline{tcpdump} output for your lab report.

    \begin{report}
    \item Explain the operation of path MTU discovery based on the \lstinline{tcpdump} outputs saved.
    
    \item Which ICMP message is used in path MTU discovery? Give the decimal value of each field of the captured ICMP message.
    
    \item What is the MTU of the destination network of the UDP datagram? Verify your answer using both the ICMP message and the IP fragmentation trace saved.
    \end{report}

\part{Exercises with FTP and TFTP}
    Use first network (section \nameref{sec:schema}) topology for this exercise.

    We will study the performance of FTP and TFTP for file transfer between two machines.
    By transferring the same file using these two protocols, we can compare the operations and performances of UDP and TCP. 

    Four files (\path{large.dum}, \path{med.dum}, \path{small.dum} and \path{this.dum}) with random contents are stored in the \path{/home/netlab} directory and in the \path{/home/netlab}\footnote{We change original path (\path{/tftpboot}) to \path{/home/netlab} to be same as ftp user path.} directory of each workstation in the lab.
    We will use the \lstinline{get} command to retrieve files from a remote host.
    When FTP is used, you need to change directory to \path{/home/netlab/} by \lstinline{cd /home/netlab} before retrieving the file.
    If you don’t know how to use \lstinline{tftp}, refer to its manual page.


\section{TFTP and FTP}
    In order to compare the transfer rates of FTP and TFTP, we will retrieve a large, med, small and thin file from a remote server using FTP and TFTP, respectively.

    First run First run the following \lstinline{tcpdump} command:
    \begin{lstlisting}[emph={your-host,remote-host}]
tcpdump host your-host and remote-host
    \end{lstlisting}
    % Here we use the redirect operator, \lstinline{>}, to save the \lstinline{tcpdump} output into a text file called \path{output1}.
    \begin{lstlisting}[emph={host}]
$ ls /etc/xinetd.d/ # see services in xinetd
$ tftp host
tftp> get $filename # thin, small, med, large
tftp> quit
$ ftp host # Enter user and password -> netlab
ftp> ls
ftp> get $filename # thin, small, med, large
ftp> quit
    \end{lstlisting}
    % Create \path{small.dum} with 10kB, \path{med.dum} with 1MB and \path{larg.dum} with 50MB.

    Also, from the \lstinline{ftp} window, record the transfer rate (time) displayed. 

    Restart the above \lstinline{tcpdump} session.

    \begin{report}
    \item Examining the saved \lstinline{tcpdump} output. Identify the starting and ending time of actual data transfer.
    Don’t include the time spent establishing the TCP connection.
    Calculate the time spent for data transfer. 

    \item Compare the time with the value displayed in \lstinline{ftp} window.
    Are they consistent?
    If there exists any significant difference, what might be the reason? 

    \item Now, from the second session, carefully determine the starting and ending time of data transfer for the \lstinline{tftp} program. 

    \item Compare the time with the value displayed in \lstinline{tftp} window.
    Are they consistent?
    If there exists any significant difference, what might be the reason? 

    \item By comparing the actual data transfer times of \lstinline{ftp} and \lstinline{tftp}, which of these two is faster, and why?
    \end{report}

\section{TFTP Analysis}
    Capture the packets that are exchanged during a \lstinline{tftp} session for the \path{/home/netlab/small.dum} file between \textit{h0} and \textit{h1}, using:
    \begin{lstlisting}[emph={your-host, remote-host}]
tcpdump -x host your-host and remote-host
    \end{lstlisting}
    Observe the protocol in action.    Analyze various types of TFTP messages. Save \lstinline{tcpdump} output for the lab report.
    
    \begin{report}
        \item List all the different types of packets exchanged during the \lstinline{tftp} session. Compare them with the TFTP message format in \hyperref[fig:5.3]{Figure~5.3} of reference book.

        Why does the server’s port number change?
        
        \item In most cases, \lstinline{tftp} service is restricted.\footnote{This is not the case in our lab, where we deliberately enabled the \lstinline{tftp} service and use it as a tool to study the UDP protocol.}
        Why is \lstinline{tftp} service not generally available to users?
        
        \item In \autoref{sec:MaxDatagramSize}, we found the maximum size of a UDP datagram in your machine. With \lstinline{tftp}, which uses UDP, we transferred a file larger than the maximum UDP datagram size.
        How do you explain this?
    \end{report}

\section{FTP Small File}
    Repeat the above experiment, but use \lstinline{ftp}.
    Capture a trace of the packets exchanged when downloading the \path{/home/netlab/small.dum} file using \lstinline{ftp}.

    Examine the port numbers used.
    
    \begin{report}
        \item How many well-known port numbers were used?
        Which machine used the well-known port numbers?
        What were the other machine’s port numbers?
        
        \item As can be seen from the \lstinline{tcpdump} output, FTP involves two different connections, \texttt{ftp-control} and \texttt{ftp-data}.
        Why are two different connections used, instead of one connection?
    \end{report}

\section{FTP Debug}
    Run \lstinline{ftp} in \textit{your-host} using the debug mode: \lstinline[emph={your-host, remote-host}]{ftp -d remote-host}.

    After logging into the remote host, type \lstinline{dir /home/netlab/small.dum} in the \lstinline{ftp} window.

    Then type \lstinline{quit} to terminate the \lstinline{ftp} session, and save the \lstinline{ftp} window output.
    
    \begin{report}
    \item Submit what you saved in this exercise, explaining each line of the output.
    Explain how the \lstinline{PORT} command works.
    Which connection, the control connection or the data connection, did the server send the response (the \lstinline{LIST} output) on?
    \end{report}

\end{document}