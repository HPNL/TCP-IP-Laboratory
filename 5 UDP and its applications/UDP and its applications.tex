\documentclass{../UTNetLab}

\title{UDP and Its Applications}
\authorshort{A. Khonsari, A. HajiAliKhamseh'i, M. Borhani, A. Khordadi, S. Kashipazha}
\author{%
    Dr. Ahmad Khonsari\\
    \FR{دکتر احمد خونساری}\\
    \mail{a\_khonsari@ut.ac.ir}
    \end{tabular}\vskip 1em
    \begin{tabular}[t]{c}
    Amir Haji Ali Khamseh'i\\
    \FR{امیر حاجی‌علی‌خمسه‌ء}\\
    \mail{khamse@ut.ac.ir}
    \and
    {Muhammad Borhani}\\
    \FR{محمد برهانی}\\
    \mail{m.borhani@ut.ac.ir}
    \and
    {AmirAhmad Khordadi}\\
    \FR{امیراحمد خردادی}\\
    \mail{a.a.khordadi@ut.ac.ir}
    \and
    {Sina Kashipazha}\\
    \FR{سینا کاشی‌پزها}\\
    \mail{sina\_kashipazha@ut.ac.ir}
    \and
    {Hadi Safari}\\
    \FR{هادی صفری}\\
    \mail{hadi.safari@ut.ac.ir}
    \and
    % {alii}\\
    % \FR{دیگران}\\
    % \mail{info@example.com}
}

\begin{document}
    \selectlanguage{english}
    \maketitle

\section*{Using the socket program}
\label{sec:schema}
	In this lab, you will not need to a router, only two workstations and one hub to connect two host together as show in \autoref{fig:5.0} and \autoref{tbl:5.0}.
	\begin{table}[H]
		\caption{Host IP addresses for Fig. 5.0}
		\label{tbl:5.0}
        \vspace{5pt}
        \centering
        \large
        \begin{tabular}{ *4l }
            \hline \hline
            \multicolumn{2}{c}{HOST\_A} & \multicolumn{2}{c}{HOST\_B} \\
            Name & Ip Address & Name & IP Address \\
            \hline 
            h0(shakti) & 128.238.61.100/24 & h1(vayu) & 128.238.61.101/24\\
            \hline \hline
            \end{tabular}
    \end{table}

    \begin{figure}[H]
        \centering
        \begin{tikzpicture}[font=\sf]
            \node[draw] (h1) at (-2,-2){HOST\_A};
            \node[draw,circle] (hub) at (0,0){Hub};
            % \node[draw,rounded corners] (router) at (0,0){\shortstack{Router}};
            % \node[draw,circle] (hub1) at (2,0){Switch 1};
            \node[draw] (h0) at (2,-2){HOST\_B};
        
            \draw[thick] (h0) -- (2,0);
            \draw[thick] (h1) -- (-2,0);
            \draw[thick] (2,0) -- (hub);
            \draw[thick] (-2,0) -- (hub);
        \end{tikzpicture}
		\caption{\textbf{Figure 5.0.} Simple router experiment.}        
		\label{fig:5.0}
    \end{figure}

\section{Socket operation}
	Use the following commands in \texttt{h0} and \texttt{h0} to observe the basic operation of \textbf{socket}\footnote{Basic command is sock use alternative socket (rename of sock)} and echo service.
	\begin{itemize}
		\item \textbf{socket [-u] \textit{host} echo}\footnote{type any text in socket and press enter}
		\item \textbf{socket -s 5555}
		\item \textbf{socket -i -n3 -w2048 \textit{server-host} 5555}
	\end{itemize}

	\subsection*{Report}
	Explain the operation of each command.

\section{socket -h}
	Study various options associated with the \textbf{socket} program.
	A brief list of options can be displayed by typing \textbf{socket}. More detailed discussion on socket can be found in
	Appendix C of [5] in the reference book.

\section{Segment size}
	While running \textbf{tcpdump -nv} on \textit{your\_host} or \textit{remote\_host}, execute the following command with different values of size (i.e., the size of the datagram). \\
	\begin{itemize}
		\item \textbf{socket -u -i -n1 -w\textit{size} \textit{remote-host} echo}
	\end{itemize}
	The \textbf{-u} option is used to send UDP datagrams rather than TCP segments. \\
	Increase \textit{size} (i.e., the size of the datagram) until fragmentation occurs. \\
	Use \textbf{netstat -in} to find out the MTU of the Ethernet interface.

	\subsection*{Report}
	What is the maximum value of \textit{size} for which the UDP datagram can be sent without IP fragmentation?
	Justify your answer with the \textbf{netstat} output.

\section{Datagram fragmentation}
	Capture the data packets generated by the following command \textbf{tcpdump src host \textit{your host}} on \texttt{h1}. \\
	\begin{itemize}
		\item \textbf{socket -u -i -n1 -w10000 \textit{host} echo}
	\end{itemize}
	\underline{Save} the \textbf{tcpdump} output for the lab report.
	\subsection*{Report}
	Explain the \textbf{tcpdump} output in terms of the IP header fields that are used in fragmentation. \\
	When IP fragmentation occurs, only the first fragment has the UDP header.
	How do you verify this fact from the \textbf{tcpdump} output?


\section{Maximum datagram size}
\label{sec:MaxDatagramSize}
	While running tcpdump src host your host, execute the following command with different values of size,
	\begin{itemize}
		\item \textbf{socket -u -i -n1 -w\textit{10000} \textit{host} echo}
		% \item  socket -u -i -n1 -w65507 host echo
	\end{itemize}
	in order to find out the maximum size of a UDP datagram that the system can send or receive, even when fragmentation is allowed.

\subsection*{Report}
	What is the maximum size of user data in a UDP datagram that the system can send or receive, even when fragmentation is allowed?


\section*{Path MTU discovery exercise}
	Connect the routers and the workstations as shown in \autoref{fig:5.2} (Fig 5.2) Change the IP
	addresses of your workstation accordingly. Note that the router IP addresses are
	the same as their default.\\
	% Open console of  each router, enable \textbf{RIP} routing (see Section 4.6 of reference book).\\
	Change the \textbf{MTU} of the \texttt{ethernet1} interfaces of \texttt{Router4} to 500
	bytes.
	\begin{itemize}
		\item \texttt{R1(config-if)\#\textbf{ip mtu 500}}
	\end{itemize}
	Test connectivity by \textbf{ping}ing hosts in the other subnets. After you can reach the
	hosts in the other subnets, run \textbf{tcpdump -nx} on your workstation.\\
	Start a UDP socket server on \textit{remote\_host}, using \textbf{socket -u -s 5555}.
	Then run the socket client from \textit{local\_host}:
	\begin{itemize}
		\item \textbf{socket -i -u -n10 -w1200 -p5 \textit{remote\_host} 5555}
	\end{itemize}

	\begin{table}[H]
        \caption{\textbf{Table 5.2} Router and Host IP addresses for \autoref{fig:5.2}}
        \vspace{5pt}
        \centering
        \large
        \begin{tabular}{ *7l }
            \hline \hline
            \multicolumn{2}{c}{Router} & \multicolumn{2}{c}{HOST\_A} & \multicolumn{2}{c}{HOST\_B} \\
            eth0 & eth1 & Name & Ip Address & Name & IP Address \\
            \hline 
            128.238.61.1/24 & 128.238.62.1/24 & h0(shakti) & 128.238.61.101/24 & h1(vayu) & 128.238.62.101/24 \\
            \hline \hline
            \end{tabular}
    \end{table}

    \begin{figure}[H]
        \centering
        \begin{tikzpicture}[font=\sf]
            \node[draw] (h1) at (-2,-2){HOST\_A};
            \node[draw,circle] (hub2) at (-2,0){Switch 2};
            \node[draw,rounded corners] (router) at (0,0){\shortstack{Router}};
            \node[draw,circle] (hub1) at (2,0){Switch 1};
            \node[draw] (h0) at (2,-2){HOST\_B};
        
            \draw[thick] (h0) -- (hub1);
            \draw[thick] (h1) -- (hub2);
            \draw[thick] (hub1) -- (router);
            \draw[thick] (hub2) -- (router);
        \end{tikzpicture}
        \caption{\textbf{Figure 5.2.} The network setup for Exercise 6 like Simple Routing section in previous chapter}
		\label{fig:5.2}
    \end{figure}

	Observe the DF bit of the first datagram and that of the following datagrams. Save the \textbf{tcpdump} output for your lab report.\\

	\subsection*{Report}
	\begin{itemize}
		\item Explain the operation of path MTU discovery based on the \textbf{tcpdump} outputs saved.
		\item Which ICMP message is used in path MTU discovery? Give the decimal value of each field of the captured ICMP message.
		\item What is the MTU of the destination network of the UDP datagram? Verify your answer using both the ICMP message and the IP fragmentation trace saved.
	\end{itemize}

\section*{Exercises with FTP and TFTP}
	Use first network (section \nameref{sec:schema}) topology for this exercise.\\
	We will study the performance of FTP and TFTP for file transfer between two machines.
	By transferring the same file using these two protocols, we can compare the operations and performances of UDP and TCP. \\
	Three files (\texttt{large.dum}, \texttt{med.dum} and \texttt{small.dum}) with random contents are stored in the \texttt{/home/netlab} directory and in the \texttt{/home/netlab}\footnote{}{We change original path (/tftpboot) to /home/netlab to be same as ftp user path.} directory of each workstation in the lab.
	We will use the \texttt{get} command to retrieve files from a remote host.
	When FTP is used, you need to change directory to \texttt{/home/netlab/} by \textbf{cd} \texttt{/home/netlab} before retrieving the file.
	If you don’t know how to use \textbf{tftp}, refer to its manual page.


\section{TFTP and FTP}
	In order to compare the transfer rates of FTP and TFTP, we will retrieve a large file from a remote server using FTP and TFTP, respectively.\\
	First run First run the following \textbf{tcpdump} command:
	\begin{itemize}
		\item \textbf{tcpdump host \textit{local\_host} and \textit{remote\_host}}
	\end{itemize}
	% Here we use the redirect operator, \texttt{>}, to save the \textbf{tcpdump} output into a text file called \textit{output1}.
	\begin{itemize}		
		\item \textbf{ls /etc/xinetd.d/} \# see services in xinetd
		\item \textbf{tftp \textit{hsot}}
		\item tftp> \textbf{get \{\$filename\}} \textit{\# small,med,large}
		\item tftp> \textbf{quit}
		\item \textbf{ftp \textit{hsot}} \# Enter user and password -> \textbf{netlab}
		\item tftp> \textbf{ls}
		\item tftp> \textbf{get \$\{filename\}}
		\item tftp> \textbf{quit}
	\end{itemize}
	% \textit{Create \textbf{small.dum} with \textbf{10kB}, \textbf{med.dum} with \textbf{1MB} and \textbf{larg.dum} with \textbf{50MB}} \\
	Also, from the \textbf{ftp} window, record the transfer rate (time) displayed. \\
	Restart the above \textbf{tcpdump} session.

	\subsection*{Report}
	Examining the saved \textbf{tcpdump} output. Identify the starting and ending time of actual data transfer.
	Don’t include the time spent establishing the TCP connection.
	Calculate the time spent for data transfer. \\
	Compare the time with the value displayed in \textbf{ftp} window.
	Are they consistent?
	If there exists any significant difference, what might be the reason? \\
	Now, from the second session, carefully determine the starting and ending time of data transfer for the \textbf{tftp} program. \\
	Compare the time with the value displayed in \textbf{tftp} window.
	Are they consistent?
	If there exists any significant difference, what might be the reason? \\
	By comparing the actual data transfer times of \textbf{ftp} and \textbf{tftp}, which of these two is faster, and why?

\section{TFTP Analysis}
	Capture the packets that are exchanged during a \textbf{tftp} session for the \linebreak \texttt{/home/netlab/small.dum} file between \texttt{h0} and \texttt{h1}, using:
	\begin{itemize}
		\item \textbf{tcpdump -x host \textit{your\_host} and \textit{remote\_host}}
	\end{itemize}
	Observe the protocol in action.	Analyze various types of TFTP messages. Save \textbf{tcpdump} output for the lab report.
	\subsection*{Report}
	\begin{enumerate}
		\item List all the different types of packets exchanged during the \textbf{tftp} session. Compare them with the TFTP message format in Fig. 5.3.\\ Why does the server’s port number change?
		\item In most cases, \textbf{tftp} service is restricted.\footnote{This is not the case in our lab, where we deliberately enabled the TFTP service and use it as a tool to study the UDP protocol.}
		Why is \textbf{tftp} service not generally available to users?
		\item In \autoref{sec:MaxDatagramSize}, we found the maximum size of a UDP datagram in your machine. With \textbf{tftp}, which uses UDP, we transferred a file larger than the maximum UDP datagram size.
		How do you explain this?
	\end{enumerate}

\section{FTP Small file}
	Repeat the above experiment, but use \textbf{ftp}.
	Capture a trace of the packets exchanged when downloading the \texttt{/home/netlab/small.dum} file using \textbf{ftp}. \\
	Examine the port numbers used.
	\subsection*{Report}
	\begin{enumerate}
		\item How many well-known port numbers were used?
		Which machine used the well-known port numbers?
		What were the other machine’s port numbers?
		\item As can be seen from the \textbf{tcpdump} output, FTP involves two different connections, \texttt{ftp-control} and \texttt{ftp-data}.
		Why are two different connections used, instead of one connection?
	\end{enumerate}

\section{FTP Debug}
	Run \textbf{ftp} in \texttt{local\_host} using the debug mode: \textbf{ftp -d} \textit{remote\_host}. \\
	After logging into the remote host, type \textbf{dir} \texttt{/home/netlab/small.dum} in the \textbf{ftp} window. \\
	Then type \textbf{quit} to terminate the \textbf{ftp} session, and save the \textbf{ftp} window output.
	\subsection*{Report}
	Submit what you saved in this exercise, explaining each line of the output.
	Explain how the \texttt{PORT} command works.
	Which connection, the control connection or the data connection, did the server send the response (the \texttt{LIST} output) on?

\end{document}